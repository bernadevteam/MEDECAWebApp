@{
    ViewBag.Title = "Ordenes Trabajos";
}

<div class="row">
    <div class="col-md-10">
        <div class="page-header">
            <h1>Ordenes Trabajos</h1>
            <h5>En este modulo podr&aacute; crear y modificar ordenes de trabajos.</h5>
        </div>
    </div>

</div>
<div class="row" ng-controller="OrdenesTrabajosController">
    <ul class="nav nav-tabs" role="tablist">
        <li role="presentation" class="active"><a href="#tabActiveOrders" aria-controls="tabActiveOrders" role="tab" data-toggle="tab"><span class="badge">{{filtered.length}}</span> Ordenes Activas </a></li>
        <li role="presentation"><a href="#tabSearch" aria-controls="tabSearch" role="tab" data-toggle="tab">B&uacute;squeda</a></li>
    </ul>
    <div class="tab-content">
        @* ========> ORDENES ACTIVAS <======== *@
        <div role="tabpanel" class="tab-pane fade in active" id="tabActiveOrders">
            <div class="flex-box">
                <div class="panel panel-red flex-item" ng-repeat="orden in modelos | ordenesactivas as filtered">
                    <div class="panel-heading" role="tab">
                        <h4 class="panel-title"></h4>
                    </div>
                    <div class="panel-body {{orden.FechaPrometida && orden.DaysOverdue < 0 ? 'list-group-item-danger' : ''}}{{orden.FechaPrometida && orden.DaysOverdue >= 0 && orden.DaysOverdue < 3 ? 'list-group-item-warning' : ''}}">

                        <div style="cursor:pointer" class="">
                            <div data-toggle="modal" data-target="#viewOrder" ng-click="editar(orden.Vehiculo.Cliente, orden.Vehiculo, orden)">
                                <h4 class="list-group-item-heading"><strong>{{orden.Vehiculo.Cliente.Nombre}}</strong></h4>
                                <div class=""></div>
                                <h3 class="list-group-item-heading"> {{orden.Vehiculo | vehicleInfo}}</h3>
                                <h4 class="list-group-item-heading">Placa: {{orden.Vehiculo.Placa}}</h4>
                                <p class="list-group-item-text">
                                    <strong>{{parseOrden(orden.NoOrden.toString())}}</strong>
                                    <br />
                                    Fecha Prometida: <label>{{orden.FechaPrometida ? "" : "-"}}{{orden.FechaPrometida | date:'dd/MM/yyyy'}}</label>
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        <div role="tabpanel" class="tab-pane" id="tabSearch">
            <div class="row">
                <div class="col-md-12">
                    <div class="input-group custom-search-form">
                        <span class="input-group-btn">
                            <button class="btn btn-success" data-toggle="modal" data-target="#manageClient" data-backdrop="static" data-keyboard="false"
                                    ng-click="addClient()">
                                <i class="fa fa-plus-square"></i>
                            </button>
                            <button class="btn btn-default" type="button">
                                <i class="fa fa-search"></i>
                            </button>
                        </span>

                        <input type="text" class="form-control" placeholder="Escriba aqu&iacute; Nombre de Cliente o Matricula del Veh&iacute;culo..." ng-disabled="!modelos"
                               ng-model="filter" value="">

                    </div>

                </div>
            </div>
            <div class="row">

                <div class="col-md-12 client-box" ng-repeat="cliente in modelos | porclienteoplaca: filter.toLowerCase()">
                    <span>
                        <a class="page-header-edit" ng-click="editClient(cliente)"
                           data-toggle="modal" data-target="#manageClient">
                            <i class="fa fa-edit fa-2x"></i>
                        </a>

                        <span class="huge editor" data-toggle="modal" data-target="#viewClient" data-backdrop="static" data-keyboard="false" ng-click="editClient(cliente)">{{cliente.Nombre}} <small>Tel.: {{cliente.Telefono}}</small></span>
                    </span>
                    <hr />
                    <div class="row col-md-12 flex-box md-padding" layout-xs="column" layout="row">
                        <div class="panel panel-red" flex-xs flex-gt-xs="22" layout="column" style="margin-right:5px" ng-repeat="vehiculo in cliente.Vehiculos | getAllByKey: (cliente.PorPlaca ? 'Placa' : null ) : filter">

                            <div class="panel-heading panel-heading-veh" ng-click="editVeh(cliente, vehiculo)"
                                 data-toggle="modal" data-target="#viewVehicle" data-backdrop="static" data-keyboard="false">
                                <div class="row">
                                    <div class="col-xs-3">
                                        <i class="fa fa-car fa-5x"></i>
                                    </div>
                                    <div class="col-xs-9 text-right">
                                        <div>{{vehiculo.Modelo.VehiculoMarca.Nombre + ' ' +vehiculo.Modelo.Nombre+' '+vehiculo.Anio}}</div>
                                        <div><strong>Placa {{vehiculo.Placa}}</strong> </div>
                                        <div>{{vehiculo.Cliente.Nombre}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="panel-body">
                                <button type="button" class="btn btn-default btn-block" ng-if="vehiculo.OrdenesTrabajos.length == 0" disabled>Sin servicios</button>
                                <div class="dropdown" ng-if="vehiculo.OrdenesTrabajos.length > 0">
                                    <button class="btn btn-default dropdown-toggle btn-block" type="button" id="dropdownMenu1" data-toggle="dropdown" aria-haspopup="true" aria-expanded="true">
                                        Ordenes
                                        <span class="caret"></span>
                                    </button>
                                    <ul class="dropdown-menu" aria-labelledby="dropdownMenu1">
                                        <li ng-repeat="ordenTrabajo in vehiculo.OrdenesTrabajos">
                                            <a href="#" data-toggle="modal" data-target="#viewOrder" ng-click="editar(cliente, vehiculo, ordenTrabajo)">
                                                <div class="panel-body">
                                                    <i class="fa fa-comment fa-sticky-note"></i> {{parseOrden(ordenTrabajo.NoOrden.toString())}}
                                                    <span class="pull-right text-muted small">
                                                        <em>{{ordenTrabajo.Fecha | date: 'dd/MM/yyyy'}}</em>
                                                    </span>
                                                </div>
                                            </a>
                                        </li>
                                    </ul>
                                </div>
                            </div>
                            <a href="#">
                                <div class="panel-footer panel-green"
                                     data-toggle="modal" data-target="#nuevaOrdenTrabajo" ng-click="editar(cliente, vehiculo)">
                                    <span class="pull-left">Crear Orden</span>
                                    <span class="pull-right"><i class="fa fa-plus"></i></span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                            <a href="#">
                                <div class="panel-footer panel-green" ng-click="editVeh(cliente, vehiculo)"
                                     data-toggle="modal" data-target="#manageVehiculo" data-backdrop="static" data-keyboard="false">

                                    <span class="pull-left">Editar</span>
                                    <span class="pull-right"><i class="fa fa-car"></i> <i class="fa fa-pencil"></i> </span>
                                    <div class="clearfix"></div>
                                </div>
                            </a>
                        </div>
                        <button class="btn btn-success btn-lg" data-toggle="modal" data-target="#manageVehiculo" data-backdrop="static" data-keyboard="false" ng-click="addVeh(cliente)"> <i class="fa fa-plus-square"></i></button>

                    </div>

                </div>
            </div>
        </div>
        <div ng-controller="VehiculosController">
            <manage-vehiculo></manage-vehiculo>
            <view-vehicle></view-vehicle>
        </div>
        <div ng-controller="ClientesController">
            <manage-client></manage-client>
            <view-client></view-client>
        </div>
        <manage-provider ng-controller="ProveedoresController"></manage-provider>
        <view-order></view-order>
{{modalCaller='#nuevaOrdenTrabajo';""}}
        @* *******************************  OT FORM ******************************* *@
        <form name="modelForm">
            <div class="modal fade" tabindex="-1" role="dialog" id="nuevaOrdenTrabajo">
                <div class="modal-dialog modal-lg">
                    <div class="modal-content">
                        <div class="modal-header">
                            <span class="star" ng-show="SelectedCliente.Favorito"></span>
                            <h4 class="modal-title">Recepci&oacute;n de Veh&iacute;culo {{parseOrden(nuevoModel.NoOrden.toString())}}</h4>
                        </div>
                        <div class="modal-body">
                            <ul id="otTabs" class="nav nav-tabs" role="tablist">
                                <li role="presentation" class="active"><a href="#otinfo" aria-controls="home" role="tab" data-toggle="tab">Info</a></li>
                                <li role="presentation"><a href="#otMant" aria-controls="otMant" role="tab" data-toggle="tab">Mantenimiento</a></li>
                                <li role="presentation"><a href="#otInsumos" aria-controls="otInsumos" role="tab" data-toggle="tab">Insumos</a></li>
                            </ul>
                            <div class="tab-content">
                                @* ========> OT INFO <======== *@
                                <div role="tabpanel" class="tab-pane fade in active" id="otinfo">
                                    <div class="form-group row">

                                        <div class="col-md-4">
                                            <label>Cliente</label>
                                            <div>
                                                {{SelectedCliente.Nombre}}
                                            </div>
                                        </div>

                                        <div class="col-md-3">
                                            <label>Veh&iacute;culo</label>
                                            <div>
                                                {{SelectedVehiculo.Info}} <br /> <strong>VIN:</strong> {{SelectedVehiculo.NoChasis}}
                                            </div>
                                        </div>
                                        <div class="col-md-2">
                                            <label>{{SelectedVehiculo.UnidadDistancia == 'Km' ? 'Kilometraje' : 'Millaje' }}:</label>
                                            <input type="text" ng-model="nuevoModel.DistanciaRecorrida" class="form-control" pattern="[0-9]+(\.[0-9][0-9]?)?" />
                                        </div>
                                        <div class="col-md-3">
                                            <label>Estado</label> <span class="required"> *</span>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio" ng-model="nuevoModel.Entregado" ng-value=false checked name="Entregado" ng-required="!nuevoModel.Entregado">
                                                    Recibido
                                                </label>
                                            </div>
                                            <div class="radio">
                                                <label>
                                                    <input type="radio" ng-model="nuevoModel.Entregado" ng-value=true name="Entregado" ng-required="!nuevoModel.Entregado">
                                                    Entregado
                                                </label>
                                            </div>
                                        </div>
                                        
                                    </div>
                                    <div class="row">
                                     </div>
                                    <h3>Fechas</h3>
                                    <hr />
                                    <div class="form-group row">
                                        <div class="col-md-4">
                                            <label>Recibido el:</label> <span class="required"> *</span>
                                            <br />
                                            <md-datepicker ng-model="nuevoModel.Fecha" required></md-datepicker>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Prometido para:</label>
                                            <br />
                                            <md-datepicker ng-model="nuevoModel.FechaPrometida"></md-datepicker>
                                        </div>
                                        <div class="col-md-4">
                                            <label>Entregado el:</label>
                                            <br />
                                            <md-datepicker ng-model="nuevoModel.FechaEntrega"></md-datepicker>
                                        </div>
                                    </div>
                                </div>
                                @* ========> OT MAINTENANCE <======== *@
                                <div role="tabpanel" class="tab-pane fade" id="otMant">
                                    <div class="form-group row">
                                        <div class="col-md-9">
                                                <label>Servicios</label>
                                            <label class="checkbox-inline" ng-repeat="servicio in servicios">
                                                <input type="checkbox" checklist-model="nuevoModel.Servicios" checklist-value="servicio">
                                                {{servicio.Nombre}}
                                            </label>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label>Aver&iacute;as</label>
                                        <textarea rows="7" class="form-control" name="averia" ng-model="nuevoModel.Fallas" spellcheck></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Diagn&oacute;stico</label>
                                        <textarea rows="7" class="form-control" name="averia" ng-model="nuevoModel.Diagnostico" spellcheck></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label>Reparaciones</label>
                                        <textarea rows="7" class="form-control" ng-model="nuevoModel.Reparaciones" spellcheck></textarea>
                                    </div>
                                </div>
                                @* ========> OT INSUMOS <======== *@
                                <div role="tabpanel" class="tab-pane fade" id="otInsumos">
                                    <div class="form-group ">
                                        <div layout="column" ng-cloak="">
                                            <md-chips ng-model="selInsumosProvs" md-autocomplete-snap="" md-require-match="true">
                                                <md-autocomplete md-selected-item="selInsumo" md-search-text="buscarInsumo" md-items="item in querySearch(buscarInsumo, SelectedVehiculo.Insumos)"
                                                                 md-item-text="item.Nombre" placeholder="Buscar insumo">
                                                    <span md-highlight-text="buscarInsumo">{{item.Nombre}} </span>
                                                </md-autocomplete>
                                                <md-chip-template>
                                                    <span>
                                                        <strong>{{$chip.Nombre}}</strong>
                                                    </span>
                                                </md-chip-template>
                                            </md-chips>
                                        </div>
                                    </div>
                                    <div class="form-group" ng-show="selInsumosProvs.length > 0">
                                        <button class="btn btn-success" data-toggle="modal" onclick="switchModal(this, '#proveedoresForm')">Agregar Proveedor <i class="fa fa-plus-square"></i></button>
                                        <table class="table table-striped">
                                            <thead>
                                                <tr>
                                                    <th class="col-md-4">Insumo</th>
                                                    <th>Proveedor <span class="required"> *</span></th>
                                                    <th class="col-md-2">Cantidad <span class="required"> *</span></th>
                                                    <th class="col-md-2">Precio <span class="required"> *</span></th>
                                                    <th class="col-md-1">Sub Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <tr ng-repeat="insumo in selInsumosProvs track by $index">
                                                    <td>{{insumo.Nombre}}</td>
                                                    <td>
                                                        <select class="form-control" ng-model="insumo.IdProveedor" required ng-options="prov.IdProveedor as prov.Nombre for prov in proveedores"></select>
                                                    </td>
                                                    <td>  <input type="number" ng-model="insumo.Cantidad" class="form-control" required /></td>
                                                    <td>  <input type="text" pattern="[0-9]+(\.[0-9][0-9]?)?" ng-model="insumo.Precio" class="form-control" required /></td>
                                                    <td>{{(insumo.Precio * insumo.Cantidad) | currency}} RD$</td>
                                                </tr>
                                            </tbody>
                                            <tfoot>
                                                <tr>
                                                    <td colspan="5">
                                                        <span class="pull-right">
                                                            <b>Total:</b> {{selInsumosProvs | totalCal: ['Precio', 'Cantidad']| currency}} RD$
                                                        </span>
                                                    </td>
                                                </tr>
                                            </tfoot>
                                        </table>

                                    </div>

                                </div>
                            </div>

                        </div>
                        <div class="modal-footer">
                            <button type="reset" class="btn btn-default" data-dismiss="modal" ng-click="restablecerNuevo()">Cerrar</button>
                            <button type="submit" class="btn btn-success" ng-disabled="modelForm.$invalid" ng-click="nuevoModel.editar ? guardar() : agregar()" data-dismiss="modal">Guardar</button>
                        </div>
                    </div><!-- /.modal-content -->
                </div><!-- /.modal-dialog -->
            </div><!-- /.modal -->
        </form>

    </div>
@section scripts{
    <script>
        $('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
            var target = $(e.target).attr("href");
            $(target).find("input:first").focus();
        });
</script>}
</div>
